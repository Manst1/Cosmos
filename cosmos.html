<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cosmos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Add Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        body {
            background: linear-gradient(to bottom, #1a1a3d, #2a2a5e);
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            font-family: 'Arial', sans-serif;
        }
        canvas {
            border: 2px solid #ffffff20;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
        }
        #gameOverScreen, #startScreen, #difficultyScreen, #highScoreScreen {
            position: absolute;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            display: none;
            max-height: 80vh;
            overflow-y: auto;
            width: 85%;
            max-width: 700px;
            box-shadow: 0 0 30px rgba(0, 200, 255, 0.3);
            border: 1px solid #00ccff50;
        }
        #scoreDisplay {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            font-size: 24px;
            text-shadow: 0 0 5px #00ffcc;
            background: rgba(0, 0, 0, 0.5);
            padding: 5px 15px;
            border-radius: 20px;
        }
        .difficulty-btn {
            background: linear-gradient(to bottom, #10b981, #059669);
            margin: 8px;
            padding: 12px 25px;
            border-radius: 8px;
            transition: all 0.3s;
            min-width: 140px;
            border: 1px solid #10b98180;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        .difficulty-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.3);
        }
        #endGameButton {
            position: absolute;
            bottom: 20px;
            background: linear-gradient(to bottom, #ef4444, #dc2626);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: none;
            border: 1px solid #ef444480;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        #endGameButton:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.3);
        }
        .high-score-list {
            list-style-type: none;
            padding: 0;
            margin: 15px 0;
            width: 100%;
        }
        .high-score-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid #334155;
            background: rgba(30, 30, 60, 0.5);
            margin-bottom: 5px;
            border-radius: 5px;
        }
        .high-score-rank {
            font-weight: bold;
            margin-right: 10px;
            color: #00ccff;
            min-width: 40px;
            text-align: center;
        }
        .high-score-name {
            flex-grow: 1;
            text-align: left;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .high-score-value {
            font-weight: bold;
            color: #00ffcc;
            min-width: 60px;
            text-align: right;
        }
        .high-score-date {
            font-size: 0.8em;
            color: #94a3b8;
            min-width: 150px;
            text-align: right;
            margin-left: 15px;
        }
        .difficulty-tabs {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
            gap: 8px;
        }
        .difficulty-tab {
            padding: 10px 20px;
            background: #1e293b;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid #334155;
        }
        .difficulty-tab.active {
            background: #0f172a;
            border-color: #00ccff;
            color: #00ccff;
            box-shadow: 0 0 10px rgba(0, 200, 255, 0.3);
        }
        .difficulty-tab:hover:not(.active) {
            background: #334155;
        }
        #highScoreTable {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        #highScoreTable th, #highScoreTable td {
            padding: 10px;
            border-bottom: 1px solid #334155;
            text-align: left;
        }
        #highScoreTable th {
            color: #00ccff;
            background: rgba(30, 30, 60, 0.5);
        }
        #highScoreTable tr:nth-child(even) {
            background: rgba(30, 30, 60, 0.3);
        }
        #highScoreTable tr:hover {
            background: rgba(0, 200, 255, 0.1);
        }
        .glowing-text {
            text-shadow: 0 0 10px currentColor;
        }
        .modal-btn {
            background: linear-gradient(to bottom, #0ea5e9, #0284c7);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
            border: 1px solid #0ea5e980;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        .modal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.3);
            background: linear-gradient(to bottom, #0284c7, #0369a1);
        }
        .modal-btn.secondary {
            background: linear-gradient(to bottom, #475569, #334155);
        }
        .modal-btn.secondary:hover {
            background: linear-gradient(to bottom, #334155, #1e293b);
        }
    </style>
</head>
<body>
    <div id="scoreDisplay">Score: 0</div>
    <canvas id="gameCanvas" width="800" height="600"></canvas>
    
    <div id="difficultyScreen">
        <h1 class="text-4xl font-bold mb-6 text-cyan-300 glowing-text">Choose Difficulty</h1>
        <div class="flex flex-wrap justify-center gap-3 mb-6">
            <button id="peacefulButton" class="difficulty-btn text-white font-bold py-2 px-4 rounded">Peaceful</button>
            <button id="normalButton" class="difficulty-btn text-white font-bold py-2 px-4 rounded">Normal</button>
            <button id="hardButton" class="difficulty-btn text-white font-bold py-2 px-4 rounded">Hard</button>
            <button id="superHardButton" class="difficulty-btn text-white font-bold py-2 px-4 rounded">Super Hard</button>
            <button id="impossibleButton" class="difficulty-btn text-white font-bold py-2 px-4 rounded">Impossible</button>
            <button id="ledianModusButton" class="difficulty-btn text-white font-bold py-2 px-4 rounded">Ledian Modus</button>
        </div>
        <button id="viewHighScoresButton" class="modal-btn secondary">View High Scores</button>
    </div>
    
    <div id="startScreen">
        <h1 class="text-4xl font-bold mb-4 text-cyan-300 glowing-text">Cosmic Collector</h1>
        <p class="text-lg mb-6">Use arrow keys or WASD to move your spaceship.<br>Collect energy orbs (blue) to score points.<br>Avoid asteroids (bright red are fast, dark red are slow)!</p>
        <button id="startButton" class="modal-btn">Start Game</button>
    </div>
    
    <div id="gameOverScreen">
        <h1 class="text-4xl font-bold mb-4 text-cyan-300 glowing-text">Game Over</h1>
        <p class="text-lg mb-4">Final Score: <span id="finalScore" class="text-cyan-200">0</span></p>
        <div id="newHighScoreMessage" class="text-yellow-300 text-xl font-bold mb-4" style="display: none;">
            New High Score! Enter your name:
            <input type="text" id="playerNameInput" class="text-black p-2 rounded mt-2" maxlength="15" placeholder="Your name">
            <button id="saveHighScoreButton" class="modal-btn bg-yellow-500 hover:bg-yellow-600 text-black">Save</button>
        </div>
        <div class="flex justify-center flex-wrap">
            <button id="retryButton" class="modal-btn">Retry</button>
            <button id="changeDifficultyButton" class="modal-btn secondary">Change Difficulty</button>
        </div>
    </div>
    
    <div id="highScoreScreen">
        <h1 class="text-4xl font-bold mb-4 text-cyan-300 glowing-text">High Scores</h1>
        <div class="difficulty-tabs">
            <div class="difficulty-tab active" data-difficulty="normal">Normal</div>
            <div class="difficulty-tab" data-difficulty="hard">Hard</div>
            <div class="difficulty-tab" data-difficulty="superHard">Super Hard</div>
            <div class="difficulty-tab" data-difficulty="impossible">Impossible</div>
            <div class="difficulty-tab" data-difficulty="ledianModus">Ledian Modus</div>
        </div>
        <div id="highScoreList"></div>
        <button id="backFromHighScoresButton" class="modal-btn secondary">Back</button>
    </div>
    
    <button id="endGameButton">Spiel beenden</button>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCYBWU0IHCJjNAqkolKubG53LjJGFgXLHM",
            authDomain: "cosmos-hs.firebaseapp.com",
            databaseURL: "https://cosmos-hs-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "cosmos-hs",
            storageBucket: "cosmos-hs.firebasestorage.app",
            messagingSenderId: "377398562660",
            appId: "1:377398562660:web:b27831050fd9eed3363471"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const startScreen = document.getElementById('startScreen');
        const gameOverScreen = document.getElementById('gameOverScreen');
        const difficultyScreen = document.getElementById('difficultyScreen');
        const highScoreScreen = document.getElementById('highScoreScreen');
        const finalScore = document.getElementById('finalScore');
        const startButton = document.getElementById('startButton');
        const retryButton = document.getElementById('retryButton');
        const changeDifficultyButton = document.getElementById('changeDifficultyButton');
        const peacefulButton = document.getElementById('peacefulButton');
        const normalButton = document.getElementById('normalButton');
        const hardButton = document.getElementById('hardButton');
        const superHardButton = document.getElementById('superHardButton');
        const impossibleButton = document.getElementById('impossibleButton');
        const ledianModusButton = document.getElementById('ledianModusButton');
        const endGameButton = document.getElementById('endGameButton');
        const viewHighScoresButton = document.getElementById('viewHighScoresButton');
        const backFromHighScoresButton = document.getElementById('backFromHighScoresButton');
        const highScoreList = document.getElementById('highScoreList');
        const newHighScoreMessage = document.getElementById('newHighScoreMessage');
        const playerNameInput = document.getElementById('playerNameInput');
        const saveHighScoreButton = document.getElementById('saveHighScoreButton');
        const difficultyTabs = document.querySelectorAll('.difficulty-tab');

        let score = 0;
        let gameRunning = false;
        let difficulty = 1;
        let selectedDifficulty = 'hard';
        let asteroidSpawnDelay = 0;
        let lastTime = 0;
        let isNewHighScore = false;

        const player = {
            x: canvas.width / 2,
            y: canvas.height / 2,
            radius: 20,
            speed: 495,
            dx: 0,
            dy: 0
        };

        const orbs = [];
        const asteroids = [];
        const keys = {};

        // High score functions
        async function checkHighScore(score, difficulty) {
            try {
                // Skip high score check for peaceful mode
                if (difficulty === 'peaceful') return false;
                
                const highScoresRef = database.ref(`highscores/${difficulty}`);
                const snapshot = await highScoresRef.orderByChild('score').limitToLast(25).once('value');
                
                let isHighScore = false;
                let count = 0;
                
                snapshot.forEach(() => {
                    count++;
                });
                
                // If there are fewer than 25 scores, any score is a high score
                if (count < 25 && score > 0) {
                    isHighScore = true;
                } else {
                    // Check if score is higher than the lowest high score
                    const lowestScoreSnapshot = await highScoresRef.orderByChild('score').limitToFirst(1).once('value');
                    lowestScoreSnapshot.forEach(childSnapshot => {
                        const childData = childSnapshot.val();
                        if (score > childData.score) isHighScore = true;
                    });
                }
                
                return isHighScore;
            } catch (error) {
                console.error("Error checking high scores:", error);
                return false;
            }
        }

        async function saveHighScore(name, score, difficulty) {
            try {
                const highScoresRef = database.ref(`highscores/${difficulty}`);
                const newScoreRef = highScoresRef.push();
                await newScoreRef.set({
                    name: name.substring(0, 15),
                    score: score,
                    timestamp: Date.now(),
                    date: new Date().toLocaleDateString(),
                    time: new Date().toLocaleTimeString()
                });
                
                // If we have more than 25 scores, remove the lowest one
                const snapshot = await highScoresRef.orderByChild('score').once('value');
                const scores = [];
                snapshot.forEach(childSnapshot => {
                    scores.push({
                        id: childSnapshot.key,
                        score: childSnapshot.val().score
                    });
                });
                
                if (scores.length > 25) {
                    // Sort by score ascending and remove the lowest
                    scores.sort((a, b) => a.score - b.score);
                    const toRemove = scores[0];
                    await highScoresRef.child(toRemove.id).remove();
                }
                
                return true;
            } catch (error) {
                console.error("Error saving high score:", error);
                return false;
            }
        }

        async function getHighScores(difficulty) {
            try {
                const highScoresRef = database.ref(`highscores/${difficulty}`);
                const snapshot = await highScoresRef.orderByChild('score').limitToLast(25).once('value');
                
                const scores = [];
                snapshot.forEach(childSnapshot => {
                    scores.push({
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    });
                });
                
                // Sort descending by score
                return scores.sort((a, b) => b.score - a.score);
            } catch (error) {
                console.error("Error getting high scores:", error);
                return [];
            }
        }

        function displayHighScores(scores) {
            if (scores.length === 0) {
                highScoreList.innerHTML = '<p class="text-lg">No high scores yet!</p>';
                return;
            }
            
            let html = '<div class="high-score-list">';
            
            scores.forEach((score, index) => {
                html += `
                    <div class="high-score-item">
                        <div class="high-score-rank">${index + 1}</div>
                        <div class="high-score-name">${score.name}</div>
                        <div class="high-score-value">${score.score}</div>
                        <div class="high-score-date">${score.date} ${score.time}</div>
                    </div>
                `;
            });
            
            html += '</div>';
            highScoreList.innerHTML = html;
        }

        function createOrb() {
            const x = Math.random() * canvas.width;
            const y = Math.random() * canvas.height;
            orbs.push({ x, y, radius: 10 });
        }

        function createAsteroid() {
            if (selectedDifficulty === 'peaceful') return;
            if (asteroidSpawnDelay > 0) return;

            const edge = Math.floor(Math.random() * 4);
            let isFast;
            if (selectedDifficulty === 'normal') {
                isFast = Math.random() < 0.3;
            } else if (selectedDifficulty === 'superHard') {
                isFast = Math.random() < 0.7;
            } else if (selectedDifficulty === 'impossible') {
                isFast = Math.random() < 0.9;
            } else if (selectedDifficulty === 'ledianModus') {
                isFast = Math.random() < 0.95;
            } else {
                isFast = Math.random() < 0.5;
            }

            let x, y, dx, dy, radius, color, speedMultiplier;

            if (isFast) {
                radius = selectedDifficulty === 'ledianModus' ? 8 : 10;
                color = '#ff6666';
                speedMultiplier = selectedDifficulty === 'ledianModus' ? 300 : 180;
            } else {
                radius = 20;
                color = '#990000';
                speedMultiplier = selectedDifficulty === 'ledianModus' ? 150 : 90;
            }

            if (edge === 0) { // Top
                x = Math.random() * canvas.width;
                y = -radius;
                dx = (Math.random() - 0.5) * 240 * difficulty * speedMultiplier / 60;
                dy = Math.random() * 120 * difficulty * speedMultiplier / 60 + 120;
            } else if (edge === 1) { // Right
                x = canvas.width + radius;
                y = Math.random() * canvas.height;
                dx = -(Math.random() * 120 * difficulty * speedMultiplier / 60 + 120);
                dy = (Math.random() - 0.5) * 240 * difficulty * speedMultiplier / 60;
            } else if (edge === 2) { // Bottom
                x = Math.random() * canvas.width;
                y = canvas.height + radius;
                dx = (Math.random() - 0.5) * 240 * difficulty * speedMultiplier / 60;
                dy = -(Math.random() * 120 * difficulty * speedMultiplier / 60 + 120);
            } else { // Left
                x = -radius;
                y = Math.random() * canvas.height;
                dx = Math.random() * 120 * difficulty * speedMultiplier / 60 + 120;
                dy = (Math.random() - 0.5) * 240 * difficulty * speedMultiplier / 60;
            }
            asteroids.push({ x, y, radius, dx, dy, color });
        }

        function drawPlayer() {
            ctx.beginPath();
            ctx.arc(player.x, player.y, player.radius, 0, Math.PI * 2);
            ctx.fillStyle = '#00ffcc';
            ctx.fill();
            ctx.strokeStyle = '#ffffff';
            ctx.stroke();
            ctx.closePath();
        }

        function drawOrbs() {
            orbs.forEach(orb => {
                ctx.beginPath();
                ctx.arc(orb.x, orb.y, orb.radius, 0, Math.PI * 2);
                ctx.fillStyle = '#00ccff';
                ctx.fill();
                ctx.closePath();
            });
        }

        function drawAsteroids() {
            asteroids.forEach(asteroid => {
                ctx.beginPath();
                ctx.arc(asteroid.x, asteroid.y, asteroid.radius, 0, Math.PI * 2);
                ctx.fillStyle = asteroid.color;
                ctx.fill();
                ctx.closePath();
            });
        }

        function updatePlayer(deltaTime) {
            player.x += player.dx * deltaTime;
            player.y += player.dy * deltaTime;

            if (player.x < player.radius) player.x = player.radius;
            if (player.x > canvas.width - player.radius) player.x = canvas.width - player.radius;
            if (player.y < player.radius) player.y = player.radius;
            if (player.y > canvas.height - player.radius) player.y = canvas.height - player.radius;
        }

        function updateOrbs() {
            for (let i = orbs.length - 1; i >= 0; i--) {
                const orb = orbs[i];
                const dx = player.x - orb.x;
                const dy = player.y - orb.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                if (distance < player.radius + orb.radius) {
                    orbs.splice(i, 1);
                    score += 10;
                    scoreDisplay.textContent = `Score: ${score}`;
                    if (selectedDifficulty === 'ledianModus' || selectedDifficulty !== 'impossible') {
                        createOrb();
                    }
                }
            }
        }

        function updateAsteroids(deltaTime) {
            for (let i = asteroids.length - 1; i >= 0; i--) {
                const asteroid = asteroids[i];
                asteroid.x += asteroid.dx * deltaTime;
                asteroid.y += asteroid.dy * deltaTime;

                const dx = player.x - asteroid.x;
                const dy = player.y - asteroid.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                if (distance < player.radius + asteroid.radius) {
                    endGame();
                    return;
                }

                if (asteroid.x < -asteroid.radius || asteroid.x > canvas.width + asteroid.radius ||
                    asteroid.y < -asteroid.radius || asteroid.y > canvas.height + asteroid.radius) {
                    asteroids.splice(i, 1);
                }
            }
        }

        function gameLoop(timestamp) {
            if (!gameRunning) return;

            const deltaTime = (timestamp - lastTime) / 1000;
            lastTime = timestamp;

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            updatePlayer(deltaTime);
            updateOrbs();
            updateAsteroids(deltaTime);
            drawPlayer();
            drawOrbs();
            drawAsteroids();

            let spawnRate;
            if (selectedDifficulty === 'normal') spawnRate = 0.01;
            else if (selectedDifficulty === 'superHard') spawnRate = 0.03;
            else if (selectedDifficulty === 'impossible') spawnRate = 0.05;
            else if (selectedDifficulty === 'ledianModus') spawnRate = 0.12;
            else spawnRate = 0.02;

            if (Math.random() < spawnRate * difficulty * deltaTime * 60) createAsteroid();
            if (orbs.length < 1 && (selectedDifficulty !== 'impossible' || orbs.length === 0)) createOrb();
            else if (selectedDifficulty === 'impossible' && orbs.length === 0) {
                for (let i = 0; i < 3; i++) createOrb();
            }

            if (asteroidSpawnDelay > 0) asteroidSpawnDelay -= deltaTime;
            difficulty += (selectedDifficulty === 'ledianModus' ? 0.0015 : 0.0005) * deltaTime * 60;

            requestAnimationFrame(gameLoop);
        }

        async function startGame() {
            gameRunning = true;
            score = 0;
            difficulty = 1;
            scoreDisplay.textContent = `Score: ${score}`;
            player.x = canvas.width / 2;
            player.y = canvas.height / 2;
            player.radius = selectedDifficulty === 'impossible' ? 25 : selectedDifficulty === 'ledianModus' ? 30 : 20;
            orbs.length = 0;
            asteroids.length = 0;
            if (selectedDifficulty === 'ledianModus') {
                createOrb();
            } else {
                for (let i = 0; i < 3; i++) createOrb();
            }
            startScreen.style.display = 'none';
            gameOverScreen.style.display = 'none';
            difficultyScreen.style.display = 'none';
            highScoreScreen.style.display = 'none';
            asteroidSpawnDelay = selectedDifficulty === 'normal' ? 15 : 0;
            endGameButton.style.display = selectedDifficulty === 'peaceful' ? 'block' : 'none';
            lastTime = performance.now();
            requestAnimationFrame(gameLoop);
        }

        async function endGame() {
            gameRunning = false;
            finalScore.textContent = score;
            
            // Check if this is a new high score (skip for peaceful mode)
            if (selectedDifficulty !== 'peaceful') {
                isNewHighScore = await checkHighScore(score, selectedDifficulty);
                
                if (isNewHighScore) {
                    newHighScoreMessage.style.display = 'block';
                    playerNameInput.focus();
                } else {
                    newHighScoreMessage.style.display = 'none';
                }
            } else {
                newHighScoreMessage.style.display = 'none';
            }
            
            gameOverScreen.style.display = 'block';
            endGameButton.style.display = 'none';
        }

        function showDifficultyScreen() {
            gameRunning = false;
            difficultyScreen.style.display = 'block';
            startScreen.style.display = 'none';
            gameOverScreen.style.display = 'none';
            highScoreScreen.style.display = 'none';
            endGameButton.style.display = 'none';
        }

        function showStartScreen() {
            startScreen.style.display = 'block';
            gameOverScreen.style.display = 'none';
            difficultyScreen.style.display = 'none';
            highScoreScreen.style.display = 'none';
            endGameButton.style.display = 'none';
        }

        async function showHighScoreScreen() {
            gameRunning = false;
            highScoreScreen.style.display = 'block';
            startScreen.style.display = 'none';
            gameOverScreen.style.display = 'none';
            difficultyScreen.style.display = 'none';
            endGameButton.style.display = 'none';
            
            // Load high scores for the first tab (Normal)
            const scores = await getHighScores('normal');
            displayHighScores(scores);
        }

        // Event listeners for difficulty tabs
        difficultyTabs.forEach(tab => {
            tab.addEventListener('click', async () => {
                // Remove active class from all tabs
                difficultyTabs.forEach(t => t.classList.remove('active'));
                // Add active class to clicked tab
                tab.classList.add('active');
                
                // Load high scores for selected difficulty
                const difficulty = tab.getAttribute('data-difficulty');
                const scores = await getHighScores(difficulty);
                displayHighScores(scores);
            });
        });

        document.addEventListener('keydown', e => {
            keys[e.key.toLowerCase()] = true;
            if (e.key === 'Enter') {
                if (startScreen.style.display === 'block') {
                    startGame();
                } else if (gameOverScreen.style.display === 'block') {
                    showStartScreen();
                }
            }
            updateMovement();
        });

        document.addEventListener('keyup', e => {
            keys[e.key.toLowerCase()] = false;
            updateMovement();
        });

        function updateMovement() {
            player.dx = 0;
            player.dy = 0;

            if (keys['arrowleft'] || keys['a']) {
                if (!keys['arrowright'] && !keys['d']) player.dx = -player.speed;
            } else if (keys['arrowright'] || keys['d']) {
                player.dx = player.speed;
            }

            if (keys['arrowup'] || keys['w']) {
                if (!keys['arrowdown'] && !keys['s']) player.dy = -player.speed;
            } else if (keys['arrowdown'] || keys['s']) {
                player.dy = player.speed;
            }
        }

        peacefulButton.addEventListener('click', () => {
            selectedDifficulty = 'peaceful';
            startScreen.style.display = 'block';
            difficultyScreen.style.display = 'none';
        });
        normalButton.addEventListener('click', () => {
            selectedDifficulty = 'normal';
            startScreen.style.display = 'block';
            difficultyScreen.style.display = 'none';
        });
        hardButton.addEventListener('click', () => {
            selectedDifficulty = 'hard';
            startScreen.style.display = 'block';
            difficultyScreen.style.display = 'none';
        });
        superHardButton.addEventListener('click', () => {
            selectedDifficulty = 'superHard';
            startScreen.style.display = 'block';
            difficultyScreen.style.display = 'none';
        });
        impossibleButton.addEventListener('click', () => {
            selectedDifficulty = 'impossible';
            startScreen.style.display = 'block';
            difficultyScreen.style.display = 'none';
        });
        ledianModusButton.addEventListener('click', () => {
            selectedDifficulty = 'ledianModus';
            startScreen.style.display = 'block';
            difficultyScreen.style.display = 'none';
        });

        startButton.addEventListener('click', startGame);
        retryButton.addEventListener('click', showStartScreen);
        changeDifficultyButton.addEventListener('click', showDifficultyScreen);
        endGameButton.addEventListener('click', showDifficultyScreen);
        
        viewHighScoresButton.addEventListener('click', showHighScoreScreen);
        backFromHighScoresButton.addEventListener('click', showDifficultyScreen);
        
        saveHighScoreButton.addEventListener('click', async () => {
            const name = playerNameInput.value.trim();
            if (name) {
                const saved = await saveHighScore(name, score, selectedDifficulty);
                if (saved) {
                    newHighScoreMessage.style.display = 'none';
                    playerNameInput.value = '';
                    alert('High score saved!');
                } else {
                    alert('Error saving high score. Please try again.');
                }
            } else {
                alert('Please enter your name');
            }
        });

        // Initialize the game
        showDifficultyScreen();
    </script>
</body>
</html>
