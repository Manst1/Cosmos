<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cosmos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Add Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        body {
            background: linear-gradient(to bottom, #1a1a3d, #2a2a5e);
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            font-family: 'Arial', sans-serif;
        }
        canvas {
            border: 2px solid #ffffff20;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
        }
        #gameOverScreen, #startScreen, #difficultyScreen, #highScoreScreen {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            display: none;
            max-height: 80vh;
            overflow-y: auto;
            width: 80%;
            max-width: 500px;
        }
        #scoreDisplay {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            font-size: 24px;
            text-shadow: 0 0 5px #00ffcc;
        }
        .difficulty-btn {
            background-color: #10b981;
            margin: 5px;
            padding: 10px 20px;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        .difficulty-btn:hover {
            background-color: #059669;
        }
        #endGameButton {
            position: absolute;
            bottom: 20px;
            background-color: #ef4444;
            color: white;
            padding: 8px 16px;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
            display: none;
        }
        #endGameButton:hover {
            background-color: #dc2626;
        }
        .high-score-list {
            list-style-type: none;
            padding: 0;
            margin: 15px 0;
        }
        .high-score-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            border-bottom: 1px solid #333;
        }
        .high-score-rank {
            font-weight: bold;
            margin-right: 10px;
        }
        .high-score-name {
            flex-grow: 1;
            text-align: left;
        }
        .high-score-value {
            font-weight: bold;
            color: #00ffcc;
        }
        #highScoreTable {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        #highScoreTable th, #highScoreTable td {
            padding: 8px;
            border-bottom: 1px solid #333;
        }
        #highScoreTable th {
            color: #00ccff;
        }
    </style>
</head>
<body>
    <div id="scoreDisplay">Score: 0</div>
    <canvas id="gameCanvas" width="800" height="600"></canvas>
    <div id="difficultyScreen">
        <h1 class="text-4xl font-bold mb-4 text-cyan-300">Choose Difficulty</h1>
        <button id="peacefulButton" class="difficulty-btn text-white font-bold py-2 px-4 rounded">Peaceful</button><br>
        <button id="normalButton" class="difficulty-btn text-white font-bold py-2 px-4 rounded">Normal</button><br>
        <button id="hardButton" class="difficulty-btn text-white font-bold py-2 px-4 rounded">Hard</button><br>
        <button id="superHardButton" class="difficulty-btn text-white font-bold py-2 px-4 rounded">Super Hard</button><br>
        <button id="impossibleButton" class="difficulty-btn text-white font-bold py-2 px-4 rounded">Impossible</button><br>
        <button id="ledianModusButton" class="difficulty-btn text-white font-bold py-2 px-4 rounded">Ledian Modus</button>
        <br><br>
        <button id="viewHighScoresButton" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded">View High Scores</button>
    </div>
    <div id="startScreen">
        <h1 class="text-4xl font-bold mb-4 text-cyan-300">Cosmic Collector</h1>
        <p class="text-lg mb-4">Use arrow keys or WASD to move your spaceship.<br>Collect energy orbs (blue) to score points.<br>Avoid asteroids (bright red are fast, dark red are slow)!</p>
        <button id="startButton" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded">Start Game</button>
        <br><br>
        <button id="startToHighScoresButton" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded">View High Scores</button>
    </div>
    <div id="gameOverScreen">
        <h1 class="text-4xl font-bold mb-4 text-cyan-300">Game Over</h1>
        <p class="text-lg mb-4">Final Score: <span id="finalScore">0</span></p>
        <div id="newHighScoreMessage" class="text-yellow-300 text-xl font-bold mb-4" style="display: none;">
            New High Score! Enter your name:
            <input type="text" id="playerNameInput" class="text-black p-2 rounded mt-2" maxlength="15" placeholder="Your name">
            <button id="saveHighScoreButton" class="bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-1 px-3 rounded ml-2">Save</button>
        </div>
        <button id="retryButton" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded mr-2">Retry</button>
        <button id="changeDifficultyButton" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded">Change Difficulty</button>
        <br><br>
        <button id="gameOverToHighScoresButton" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded">View High Scores</button>
    </div>
    <div id="highScoreScreen">
        <h1 class="text-4xl font-bold mb-4 text-cyan-300">High Scores</h1>
        <select id="highScoreDifficultySelect" class="text-black p-2 rounded mb-4">
            <option value="peaceful">Peaceful</option>
            <option value="normal">Normal</option>
            <option value="hard" selected>Hard</option>
            <option value="superHard">Super Hard</option>
            <option value="impossible">Impossible</option>
            <option value="ledianModus">Ledian Modus</option>
        </select>
        <div id="highScoreList"></div>
        <button id="backFromHighScoresButton" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded mt-4">Back</button>
    </div>
    <button id="endGameButton">Spiel beenden</button>
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCYBWU0IHCJjNAqkolKubG53LjJGFgXLHM",
            authDomain: "cosmos-hs.firebaseapp.com",
            databaseURL: "https://cosmos-hs-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "cosmos-hs",
            storageBucket: "cosmos-hs.firebasestorage.app",
            messagingSenderId: "377398562660",
            appId: "1:377398562660:web:b27831050fd9eed3363471"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const startScreen = document.getElementById('startScreen');
        const gameOverScreen = document.getElementById('gameOverScreen');
        const difficultyScreen = document.getElementById('difficultyScreen');
        const highScoreScreen = document.getElementById('highScoreScreen');
        const finalScore = document.getElementById('finalScore');
        const startButton = document.getElementById('startButton');
        const retryButton = document.getElementById('retryButton');
        const changeDifficultyButton = document.getElementById('changeDifficultyButton');
        const peacefulButton = document.getElementById('peacefulButton');
        const normalButton = document.getElementById('normalButton');
        const hardButton = document.getElementById('hardButton');
        const superHardButton = document.getElementById('superHardButton');
        const impossibleButton = document.getElementById('impossibleButton');
        const ledianModusButton = document.getElementById('ledianModusButton');
        const endGameButton = document.getElementById('endGameButton');
        const viewHighScoresButton = document.getElementById('viewHighScoresButton');
        const startToHighScoresButton = document.getElementById('startToHighScoresButton');
        const gameOverToHighScoresButton = document.getElementById('gameOverToHighScoresButton');
        const backFromHighScoresButton = document.getElementById('backFromHighScoresButton');
        const highScoreDifficultySelect = document.getElementById('highScoreDifficultySelect');
        const highScoreList = document.getElementById('highScoreList');
        const newHighScoreMessage = document.getElementById('newHighScoreMessage');
        const playerNameInput = document.getElementById('playerNameInput');
        const saveHighScoreButton = document.getElementById('saveHighScoreButton');

        let score = 0;
        let gameRunning = false;
        let difficulty = 1;
        let selectedDifficulty = 'hard';
        let asteroidSpawnDelay = 0;
        let lastTime = 0; // For delta-time calculation
        let isNewHighScore = false;

        const player = {
            x: canvas.width / 2,
            y: canvas.height / 2,
            radius: 20,
            speed: 495, // Pixels per second (5 * 60 for 60 FPS equivalence)
            dx: 0,
            dy: 0
        };

        const orbs = [];
        const asteroids = [];
        const keys = {};

        // High score functions
        async function checkHighScore(score, difficulty) {
            try {
                const highScoresRef = database.ref(`highscores/${difficulty}`);
                const snapshot = await highScoresRef.orderByChild('score').limitToLast(10).once('value');
                
                let isHighScore = false;
                let lowestHighScore = 0;
                let count = 0;
                
                snapshot.forEach(childSnapshot => {
                    count++;
                    const childData = childSnapshot.val();
                    if (count === 1) lowestHighScore = childData.score;
                    if (score > childData.score) isHighScore = true;
                });
                
                // If there are fewer than 10 scores, any score is a high score
                if (count < 10 && score > 0) isHighScore = true;
                
                return isHighScore;
            } catch (error) {
                console.error("Error checking high scores:", error);
                return false;
            }
        }

        async function saveHighScore(name, score, difficulty) {
            try {
                const highScoresRef = database.ref(`highscores/${difficulty}`);
                const newScoreRef = highScoresRef.push();
                await newScoreRef.set({
                    name: name.substring(0, 15),
                    score: score,
                    timestamp: Date.now()
                });
                return true;
            } catch (error) {
                console.error("Error saving high score:", error);
                return false;
            }
        }

        async function getHighScores(difficulty) {
            try {
                const highScoresRef = database.ref(`highscores/${difficulty}`);
                const snapshot = await highScoresRef.orderByChild('score').limitToLast(10).once('value');
                
                const scores = [];
                snapshot.forEach(childSnapshot => {
                    scores.push({
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    });
                });
                
                // Sort descending by score
                return scores.sort((a, b) => b.score - a.score);
            } catch (error) {
                console.error("Error getting high scores:", error);
                return [];
            }
        }

        function displayHighScores(scores) {
            if (scores.length === 0) {
                highScoreList.innerHTML = '<p class="text-lg">No high scores yet!</p>';
                return;
            }
            
            let html = '<table id="highScoreTable" class="w-full"><tr><th>Rank</th><th>Name</th><th>Score</th></tr>';
            
            scores.forEach((score, index) => {
                html += `
                    <tr>
                        <td class="text-center">${index + 1}</td>
                        <td>${score.name}</td>
                        <td class="text-center">${score.score}</td>
                    </tr>
                `;
            });
            
            html += '</table>';
            highScoreList.innerHTML = html;
        }

        function createOrb() {
            const x = Math.random() * canvas.width;
            const y = Math.random() * canvas.height;
            orbs.push({ x, y, radius: 10 });
        }

        function createAsteroid() {
            if (selectedDifficulty === 'peaceful') return;
            if (asteroidSpawnDelay > 0) return;

            const edge = Math.floor(Math.random() * 4);
            let isFast;
            if (selectedDifficulty === 'normal') {
                isFast = Math.random() < 0.3;
            } else if (selectedDifficulty === 'superHard') {
                isFast = Math.random() < 0.7;
            } else if (selectedDifficulty === 'impossible') {
                isFast = Math.random() < 0.9;
            } else if (selectedDifficulty === 'ledianModus') {
                isFast = Math.random() < 0.95;
            } else {
                isFast = Math.random() < 0.5;
            }

            let x, y, dx, dy, radius, color, speedMultiplier;

            if (isFast) {
                radius = selectedDifficulty === 'ledianModus' ? 8 : 10;
                color = '#ff6666';
                speedMultiplier = selectedDifficulty === 'ledianModus' ? 300 : 180; // 5 * 60 or 3 * 60
            } else {
                radius = 20;
                color = '#990000';
                speedMultiplier = selectedDifficulty === 'ledianModus' ? 150 : 90; // 2.5 * 60 or 1.5 * 60
            }

            if (edge === 0) { // Top
                x = Math.random() * canvas.width;
                y = -radius;
                dx = (Math.random() - 0.5) * 240 * difficulty * speedMultiplier / 60; // 4 * 60
                dy = Math.random() * 120 * difficulty * speedMultiplier / 60 + 120; // 2 * 60
            } else if (edge === 1) { // Right
                x = canvas.width + radius;
                y = Math.random() * canvas.height;
                dx = -(Math.random() * 120 * difficulty * speedMultiplier / 60 + 120);
                dy = (Math.random() - 0.5) * 240 * difficulty * speedMultiplier / 60;
            } else if (edge === 2) { // Bottom
                x = Math.random() * canvas.width;
                y = canvas.height + radius;
                dx = (Math.random() - 0.5) * 240 * difficulty * speedMultiplier / 60;
                dy = -(Math.random() * 120 * difficulty * speedMultiplier / 60 + 120);
            } else { // Left
                x = -radius;
                y = Math.random() * canvas.height;
                dx = Math.random() * 120 * difficulty * speedMultiplier / 60 + 120;
                dy = (Math.random() - 0.5) * 240 * difficulty * speedMultiplier / 60;
            }
            asteroids.push({ x, y, radius, dx, dy, color });
        }

        function drawPlayer() {
            ctx.beginPath();
            ctx.arc(player.x, player.y, player.radius, 0, Math.PI * 2);
            ctx.fillStyle = '#00ffcc';
            ctx.fill();
            ctx.strokeStyle = '#ffffff';
            ctx.stroke();
            ctx.closePath();
        }

        function drawOrbs() {
            orbs.forEach(orb => {
                ctx.beginPath();
                ctx.arc(orb.x, orb.y, orb.radius, 0, Math.PI * 2);
                ctx.fillStyle = '#00ccff';
                ctx.fill();
                ctx.closePath();
            });
        }

        function drawAsteroids() {
            asteroids.forEach(asteroid => {
                ctx.beginPath();
                ctx.arc(asteroid.x, asteroid.y, asteroid.radius, 0, Math.PI * 2);
                ctx.fillStyle = asteroid.color;
                ctx.fill();
                ctx.closePath();
            });
        }

        function updatePlayer(deltaTime) {
            player.x += player.dx * deltaTime;
            player.y += player.dy * deltaTime;

            if (player.x < player.radius) player.x = player.radius;
            if (player.x > canvas.width - player.radius) player.x = canvas.width - player.radius;
            if (player.y < player.radius) player.y = player.radius;
            if (player.y > canvas.height - player.radius) player.y = canvas.height - player.radius;
        }

        function updateOrbs() {
            for (let i = orbs.length - 1; i >= 0; i--) {
                const orb = orbs[i];
                const dx = player.x - orb.x;
                const dy = player.y - orb.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                if (distance < player.radius + orb.radius) {
                    orbs.splice(i, 1);
                    score += 10;
                    scoreDisplay.textContent = `Score: ${score}`;
                    if (selectedDifficulty === 'ledianModus' || selectedDifficulty !== 'impossible') {
                        createOrb();
                    }
                }
            }
        }

        function updateAsteroids(deltaTime) {
            for (let i = asteroids.length - 1; i >= 0; i--) {
                const asteroid = asteroids[i];
                asteroid.x += asteroid.dx * deltaTime;
                asteroid.y += asteroid.dy * deltaTime;

                const dx = player.x - asteroid.x;
                const dy = player.y - asteroid.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                if (distance < player.radius + asteroid.radius) {
                    endGame();
                    return;
                }

                if (asteroid.x < -asteroid.radius || asteroid.x > canvas.width + asteroid.radius ||
                    asteroid.y < -asteroid.radius || asteroid.y > canvas.height + asteroid.radius) {
                    asteroids.splice(i, 1);
                }
            }
        }

        function gameLoop(timestamp) {
            if (!gameRunning) return;

            const deltaTime = (timestamp - lastTime) / 1000; // Convert to seconds
            lastTime = timestamp;

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            updatePlayer(deltaTime);
            updateOrbs();
            updateAsteroids(deltaTime);
            drawPlayer();
            drawOrbs();
            drawAsteroids();

            let spawnRate;
            if (selectedDifficulty === 'normal') spawnRate = 0.01;
            else if (selectedDifficulty === 'superHard') spawnRate = 0.03;
            else if (selectedDifficulty === 'impossible') spawnRate = 0.05;
            else if (selectedDifficulty === 'ledianModus') spawnRate = 0.12;
            else spawnRate = 0.02;

            if (Math.random() < spawnRate * difficulty * deltaTime * 60) createAsteroid();
            if (orbs.length < 1 && (selectedDifficulty !== 'impossible' || orbs.length === 0)) createOrb();
            else if (selectedDifficulty === 'impossible' && orbs.length === 0) {
                for (let i = 0; i < 3; i++) createOrb();
            }

            if (asteroidSpawnDelay > 0) asteroidSpawnDelay -= deltaTime;
            difficulty += (selectedDifficulty === 'ledianModus' ? 0.0015 : 0.0005) * deltaTime * 60;

            requestAnimationFrame(gameLoop);
        }

        async function startGame() {
            gameRunning = true;
            score = 0;
            difficulty = 1;
            scoreDisplay.textContent = `Score: ${score}`;
            player.x = canvas.width / 2;
            player.y = canvas.height / 2;
            player.radius = selectedDifficulty === 'impossible' ? 25 : selectedDifficulty === 'ledianModus' ? 30 : 20;
            orbs.length = 0;
            asteroids.length = 0;
            if (selectedDifficulty === 'ledianModus') {
                createOrb();
            } else {
                for (let i = 0; i < 3; i++) createOrb();
            }
            startScreen.style.display = 'none';
            gameOverScreen.style.display = 'none';
            difficultyScreen.style.display = 'none';
            highScoreScreen.style.display = 'none';
            asteroidSpawnDelay = selectedDifficulty === 'normal' ? 15 : 0; // In seconds
            endGameButton.style.display = selectedDifficulty === 'peaceful' ? 'block' : 'none';
            lastTime = performance.now();
            requestAnimationFrame(gameLoop);
        }

        async function endGame() {
            gameRunning = false;
            finalScore.textContent = score;
            
            // Check if this is a new high score
            isNewHighScore = await checkHighScore(score, selectedDifficulty);
            
            if (isNewHighScore) {
                newHighScoreMessage.style.display = 'block';
                playerNameInput.focus();
            } else {
                newHighScoreMessage.style.display = 'none';
            }
            
            gameOverScreen.style.display = 'block';
            endGameButton.style.display = 'none';
        }

        function showDifficultyScreen() {
            gameRunning = false;
            difficultyScreen.style.display = 'block';
            startScreen.style.display = 'none';
            gameOverScreen.style.display = 'none';
            highScoreScreen.style.display = 'none';
            endGameButton.style.display = 'none';
        }

        function showStartScreen() {
            startScreen.style.display = 'block';
            gameOverScreen.style.display = 'none';
            difficultyScreen.style.display = 'none';
            highScoreScreen.style.display = 'none';
            endGameButton.style.display = 'none';
        }

        async function showHighScoreScreen() {
            gameRunning = false;
            highScoreScreen.style.display = 'block';
            startScreen.style.display = 'none';
            gameOverScreen.style.display = 'none';
            difficultyScreen.style.display = 'none';
            endGameButton.style.display = 'none';
            
            // Load high scores for the selected difficulty
            const difficulty = highScoreDifficultySelect.value;
            const scores = await getHighScores(difficulty);
            displayHighScores(scores);
        }

        document.addEventListener('keydown', e => {
            keys[e.key.toLowerCase()] = true;
            if (e.key === 'Enter') {
                if (startScreen.style.display === 'block') {
                    startGame();
                } else if (gameOverScreen.style.display === 'block') {
                    showStartScreen();
                }
            }
            updateMovement();
        });

        document.addEventListener('keyup', e => {
            keys[e.key.toLowerCase()] = false;
            updateMovement();
        });

        function updateMovement() {
            player.dx = 0;
            player.dy = 0;

            if (keys['arrowleft'] || keys['a']) {
                if (!keys['arrowright'] && !keys['d']) player.dx = -player.speed;
            } else if (keys['arrowright'] || keys['d']) {
                player.dx = player.speed;
            }

            if (keys['arrowup'] || keys['w']) {
                if (!keys['arrowdown'] && !keys['s']) player.dy = -player.speed;
            } else if (keys['arrowdown'] || keys['s']) {
                player.dy = player.speed;
            }
        }

        peacefulButton.addEventListener('click', () => {
            selectedDifficulty = 'peaceful';
            startScreen.style.display = 'block';
            difficultyScreen.style.display = 'none';
        });
        normalButton.addEventListener('click', () => {
            selectedDifficulty = 'normal';
            startScreen.style.display = 'block';
            difficultyScreen.style.display = 'none';
        });
        hardButton.addEventListener('click', () => {
            selectedDifficulty = 'hard';
            startScreen.style.display = 'block';
            difficultyScreen.style.display = 'none';
        });
        superHardButton.addEventListener('click', () => {
            selectedDifficulty = 'superHard';
            startScreen.style.display = 'block';
            difficultyScreen.style.display = 'none';
        });
        impossibleButton.addEventListener('click', () => {
            selectedDifficulty = 'impossible';
            startScreen.style.display = 'block';
            difficultyScreen.style.display = 'none';
        });
        ledianModusButton.addEventListener('click', () => {
            selectedDifficulty = 'ledianModus';
            startScreen.style.display = 'block';
            difficultyScreen.style.display = 'none';
        });

        startButton.addEventListener('click', startGame);
        retryButton.addEventListener('click', showStartScreen);
        changeDifficultyButton.addEventListener('click', showDifficultyScreen);
        endGameButton.addEventListener('click', showDifficultyScreen);
        
        viewHighScoresButton.addEventListener('click', showHighScoreScreen);
        startToHighScoresButton.addEventListener('click', showHighScoreScreen);
        gameOverToHighScoresButton.addEventListener('click', showHighScoreScreen);
        backFromHighScoresButton.addEventListener('click', showDifficultyScreen);
        
        highScoreDifficultySelect.addEventListener('change', async () => {
            const difficulty = highScoreDifficultySelect.value;
            const scores = await getHighScores(difficulty);
            displayHighScores(scores);
        });
        
        saveHighScoreButton.addEventListener('click', async () => {
            const name = playerNameInput.value.trim();
            if (name) {
                const saved = await saveHighScore(name, score, selectedDifficulty);
                if (saved) {
                    newHighScoreMessage.style.display = 'none';
                    playerNameInput.value = '';
                    alert('High score saved!');
                } else {
                    alert('Error saving high score. Please try again.');
                }
            } else {
                alert('Please enter your name');
            }
        });

        // Initialize the game
        showDifficultyScreen();
    </script>
</body>
</html>
